<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.side.wiki.mapper.DocumentMapper">
	
	<resultMap type="com.side.wiki.vo.DocumentVO" id="doc">
		<id column="doc_title" property="docTitle"/>
		<result column="doc_content" property="docContent" />
		<result column="doc_date" property="docDate" javaType="java.util.Date" />
		<result column="doc_id" property="docId" />
		<result column="chapter_index" property="chapterIndex" />
		<result column="chapter_title" property="chapterTitle" />
		<result column="chapter_content" property="chapterContent" />
	</resultMap>
	
	<resultMap type="com.side.wiki.vo.ChapterVO" id="chapter">
		<id column="doc_title" property="docTitle"/>
		<result column="chapter_index" property="chapterIndex"/>
		<result column="chapter_content" property="chapterContent"/>
	</resultMap>
		
	
	<select id="getDoc" resultMap="doc" parameterType="string">
		select d.doc_title, doc_content, doc_date, doc_id, chapter_title, c.chapter_index
		from doc d inner join chapter c
		on d.doc_title = c.doc_title
		where d.doc_title = #{docTitle}
		order by c.chapter_index
	</select>
	 
	<select id="getDetail" resultMap="chapter" parameterType="string">
		select * 
		from detail
		where doc_title = #{docTitle}
	</select> 
	 
	<insert id="insertDoc">
		insert into doc(doc_title, doc_content, doc_date, doc_id)
		values(#{docTitle}, #{docContent}, sysdate, doc_seq.nextval)
	</insert>
	
	<insert id="insertChapter">
		insert into chapter(doc_title, chapter_title, chapter_index)
		values(#{docTitle}, #{chapterTitle}, #{chapterIndex})
	</insert>
	
	<insert id="insertDetail">
		insert into detail(doc_title, chapter_content, chapter_index)
		values(#{docTitle}, #{chapterContent}, #{chapterIndex})
	</insert>

	<update id="updateDoc">
		update doc set doc_content = #{docContent}, doc_date
		= sysdate where doc_title = #{docTitle}
	</update>

	<delete id="deleteDoc">
		delete from doc where doc_title = #{docTitle}
	</delete>

	<select id="getRandomDoc" resultMap="doc">
		select *
		from
		(select * from doc order by dbms_random.value)
		where rownum = 1
	</select>
	
	<select id="getDocList" resultType="arraylist" resultMap="doc" parameterType="com.side.wiki.vo.PagingVO">
		select * 
		from (select rownum as rnum, e.*
			from (
					select doc_id, doc_title, doc_content, doc_date
					from doc
				  )e
			) where rnum between #{startRow} and #{endRow}
	</select>

	<select id="getTotalCount" resultType="int">
		select count(*) from doc
	</select>
	
	<select id="searchList" parameterType="String" resultType="String">
		select doc_title
		from doc
		where doc_title like #{search}||'%'
	</select>

</mapper>